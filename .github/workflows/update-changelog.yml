name: Update Changelog and Docs from OCS PR

on:
  repository_dispatch:
    types: [ocs_changelog_update]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'OCS PR number'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  update-changelog-and-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Determine base branch
        id: determine_branch
        run: |
          # Determine base branch before checkout
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            IS_WIDGET="${{ github.event.client_payload.is_widget_change }}"
          else
            # For manual trigger, fetch PR info to determine if it's widget-related
            echo "Fetching PR data to determine widget status..."
            PR_DATA=$(gh api repos/dimagi/open-chat-studio/pulls/${{ inputs.pr_number }}) || { echo "Failed to fetch PR data"; exit 1; }
            FILES=$(echo "$PR_DATA" | jq -r '.files[]?.filename // empty')
            if echo "$FILES" | grep -q "^components/"; then
              IS_WIDGET="true"
            else
              IS_WIDGET="false"
            fi
          fi

          if [ "$IS_WIDGET" == "true" ]; then
            BASE_BRANCH="widget-develop"
          else
            BASE_BRANCH="main"
          fi

          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          echo "is_widget_change=$IS_WIDGET" >> $GITHUB_OUTPUT
          echo "Using base branch: $BASE_BRANCH (widget change: $IS_WIDGET)"
        env:
          GH_TOKEN: ${{ secrets.OCS_DOCS_PAT }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.determine_branch.outputs.base_branch }}
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set variables from dispatch or manual input
        id: set_vars
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "pr_number=${{ github.event.client_payload.pr_number }}" >> $GITHUB_OUTPUT
            echo "pr_title=${{ github.event.client_payload.pr_title }}" >> $GITHUB_OUTPUT
            echo "pr_url=${{ github.event.client_payload.pr_url }}" >> $GITHUB_OUTPUT
            echo "pr_author=${{ github.event.client_payload.pr_author }}" >> $GITHUB_OUTPUT
            echo "pr_merged_at=${{ github.event.client_payload.pr_merged_at }}" >> $GITHUB_OUTPUT
            echo "pr_body=${{ toJSON(github.event.client_payload.pr_body) }}" >> $GITHUB_OUTPUT
            echo "pr_labels=${{ toJSON(github.event.client_payload.pr_labels) }}" >> $GITHUB_OUTPUT
            IS_WIDGET="${{ github.event.client_payload.is_widget_change }}"
            echo "is_widget_change=$IS_WIDGET" >> $GITHUB_OUTPUT
            echo "changed_files=${{ toJSON(github.event.client_payload.changed_files) }}" >> $GITHUB_OUTPUT
          else
            echo "pr_number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
            # Fetch PR details using GitHub API
            PR_DATA=$(gh api repos/dimagi/open-chat-studio/pulls/${{ inputs.pr_number }}) || { echo "Failed to fetch PR data"; exit 1; }

            # Use multiline outputs for safe escaping
            {
              echo "pr_title<<EOF"
              echo "$PR_DATA" | jq -r '.title'
              echo "EOF"
            } >> $GITHUB_OUTPUT

            {
              echo "pr_url<<EOF"
              echo "$PR_DATA" | jq -r '.html_url'
              echo "EOF"
            } >> $GITHUB_OUTPUT

            {
              echo "pr_author<<EOF"
              echo "$PR_DATA" | jq -r '.user.login'
              echo "EOF"
            } >> $GITHUB_OUTPUT

            {
              echo "pr_merged_at<<EOF"
              echo "$PR_DATA" | jq -r '.merged_at'
              echo "EOF"
            } >> $GITHUB_OUTPUT

            {
              echo "pr_body<<EOF"
              echo "$PR_DATA" | jq -r '.body'
              echo "EOF"
            } >> $GITHUB_OUTPUT

            {
              echo "pr_labels<<EOF"
              echo "$PR_DATA" | jq -r '[.labels[].name]'
              echo "EOF"
            } >> $GITHUB_OUTPUT

            # Get widget change status and changed files list
            echo "is_widget_change=${{ steps.determine_branch.outputs.is_widget_change }}" >> $GITHUB_OUTPUT
            echo "changed_files=$(echo "$PR_DATA" | jq -c '[.files[].filename]')" >> $GITHUB_OUTPUT
          fi

          # Use base branch from determine_branch step (already determined correctly)
          echo "base_branch=${{ steps.determine_branch.outputs.base_branch }}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.OCS_DOCS_PAT }}

      - name: Create branch for changelog update
        run: |
          BRANCH_NAME="changelog-pr-${{ steps.set_vars.outputs.pr_number }}-${{ github.run_number }}"
          git checkout -b $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create instruction file for Claude
        run: |
          cat > /tmp/claude_instructions.md << 'EOF'
          You need to update the changelog and documentation in this repository based on a merged PR from the open-chat-studio repository.

          ## PR Information
          - **PR Number:** #${{ steps.set_vars.outputs.pr_number }}
          - **PR Title:** ${{ steps.set_vars.outputs.pr_title }}
          - **PR URL:** ${{ steps.set_vars.outputs.pr_url }}
          - **Author:** ${{ steps.set_vars.outputs.pr_author }}
          - **Merged Date:** ${{ steps.set_vars.outputs.pr_merged_at }}
          - **Labels:** ${{ steps.set_vars.outputs.pr_labels }}
          - **Is Widget Change:** ${{ steps.set_vars.outputs.is_widget_change }}
          - **Base Branch:** ${{ steps.set_vars.outputs.base_branch }}

          ## PR Description
          ```
          ${{ steps.set_vars.outputs.pr_body }}
          ```

          ## Important Context
          ${{ steps.set_vars.outputs.is_widget_change == 'true' && '**This PR modifies the chat widget** (files in components/ folder). Widget documentation should be updated in the chat_widget/ directory.' || 'This PR modifies the main Open Chat Studio application.' }}

          ## Your Tasks

          ### Task 1: Update Changelog

          **IMPORTANT: The changelog file to update depends on whether this is a widget change:**

          ${{ steps.set_vars.outputs.is_widget_change == 'true' && '
          #### Widget Changelog (This PR)

          Since this PR modifies widget files, update the **widget changelog** at `docs/chat_widget/changelog.md`.

          **Widget Changelog Structure:**
          - The widget changelog is organized by **version numbers** (e.g., v0.4.8, v0.4.7)
          - Entries are bullet points under each version
          - NO date-based sections
          - NO TYPE prefixes (NEW, CHANGE, BUG)
          - Read the existing widget changelog to understand the format

          **Steps for Widget Changelog:**
          1. Read `docs/chat_widget/changelog.md` to understand the current structure
          2. Find the latest version section (e.g., v0.4.8)
          3. Add your entry as a new bullet point under that version
          4. If a new version is being released, check the PR description for version info
          5. Follow the existing style: concise bullet points describing changes

          **Widget Changelog Format:**
          ```markdown
          ### v0.4.8

          * Fix horizontal scrollbar styling.
          * Improve scrolling behavior for new messages.
          * Your new entry here.
          ```
          ' || '
          #### Main Changelog (This PR)

          Since this PR modifies main app files, update the **main changelog** at `docs/changelog.md`.

          **Main Changelog Structure:**
          - The main changelog is organized by **dates** (e.g., "Oct 22, 2025")
          - Entries use TYPE prefixes: **NEW**, **CHANGE**, **BUG**, **MIGRATION**
          - Format: * **[TYPE]** [Description]

          **Steps for Main Changelog:**
          1. Read `docs/changelog.md` to understand the current structure
          2. Analyze the PR title, description, and labels to understand what changed
          3. Determine the appropriate changelog type:
             - **NEW**: New features or functionality
             - **CHANGE**: Modifications to existing features
             - **BUG**: Bug fixes
             - **MIGRATION**: Migration-related changes or breaking changes
          4. Write a clear, concise changelog entry (1-2 sentences max)
          5. Add the entry to the changelog under the appropriate date section
          6. Format the merged date as "MMM D, YYYY" (e.g., "Oct 22, 2025")
          7. If a section for that date already exists, add to it; otherwise create a new date section

          **Main Changelog Format:**
          ```markdown
          ## Oct 22, 2025
          * **NEW** Added support for parallel pipeline execution.
          * **BUG** Fixed issue with session timeout handling.
          ```
          '}}

          **General Changelog Guidelines (both types):**
          - Be concise but informative
          - Focus on user-facing changes
          - Use active voice (e.g., "Added support for..." not "Support was added for...")
          - Don't include internal implementation details unless they affect users
          - If the PR is purely internal/refactoring with no user impact, you can skip the changelog
          - Match the style and tone of existing changelog entries

          ### Task 2: Update Documentation

          After updating the changelog, analyze whether this PR requires documentation updates:

          1. **Check if documentation is needed:**
             - New features → Need user guides, how-tos, or concept docs
             - API changes → Update API documentation
             - Configuration changes → Update setup/configuration docs
             - Behavior changes → Update relevant user guides
             - Bug fixes → Usually no docs needed unless it changes behavior
             - Internal/refactoring → Skip documentation updates

          2. **If documentation IS needed:**
             - Use the Task tool with subagent_type="mkdocs-technical-writer" to handle the documentation updates
             - Provide the agent with:
               * What changed (from the PR)
               * What documentation needs to be created or updated
               * Context from the PR description
             - The agent will find the right place in the docs structure and update accordingly
             - Review the agent's output to ensure quality

          3. **If documentation is NOT needed:**
             - Simply skip this task and proceed to commit

          ### Task 3: Commit Changes

          After completing the above tasks, commit your changes with the message:
          "update changelog and docs from OCS PR #${{ steps.set_vars.outputs.pr_number }}"

          **IMPORTANT:** Do NOT create a pull request - just commit the changes to this branch. The workflow will create the PR.

          ## Important Guidelines

          - Focus on user-facing changes
          - Be clear and concise in both changelog and documentation
          - Match the style of existing content
          - If unsure whether docs are needed, err on the side of including them for NEW features
          - For CHANGE and BUG types, docs updates are usually optional unless behavior significantly changes
          EOF

      - name: Run Claude Code to generate changelog and update docs
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.OCS_DOCS_PAT }}
          prompt_file: /tmp/claude_instructions.md
          claude_args: |
            --allowedTools "Read,Write,Edit,Glob,Grep,Task,Bash(git add:*),Bash(git commit:*)"

      - name: Check for changes and push
        id: check_changes
        run: |
          BASE_BRANCH="${{ steps.set_vars.outputs.base_branch }}"

          if git diff --quiet origin/$BASE_BRANCH; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes made by Claude"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # Determine which changelog file to check based on widget change flag
            if [ "${{ steps.set_vars.outputs.is_widget_change }}" == "true" ]; then
              CHANGELOG_FILE="docs/chat_widget/changelog.md"
            else
              CHANGELOG_FILE="docs/changelog.md"
            fi

            # Check what was changed
            CHANGELOG_CHANGED=$(git diff --name-only origin/$BASE_BRANCH | grep -c "$CHANGELOG_FILE" || echo "0")
            DOCS_CHANGED=$(git diff --name-only origin/$BASE_BRANCH | grep -v "$CHANGELOG_FILE" | grep -c "docs/" || echo "0")

            echo "changelog_changed=$CHANGELOG_CHANGED" >> $GITHUB_OUTPUT
            echo "docs_changed=$DOCS_CHANGED" >> $GITHUB_OUTPUT
            echo "changelog_file=$CHANGELOG_FILE" >> $GITHUB_OUTPUT

            echo "Pushing changes to origin/${{ env.branch_name }}..."
            git push origin ${{ env.branch_name }} || { echo "Failed to push changes"; exit 1; }
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # Determine PR title based on what changed
          if [ "${{ steps.check_changes.outputs.docs_changed }}" != "0" ]; then
            PR_TITLE="Update Changelog and Docs from OCS PR #${{ steps.set_vars.outputs.pr_number }}"
            CHANGES_DESC="Automated changelog and documentation updates"
          else
            PR_TITLE="Update Changelog from OCS PR #${{ steps.set_vars.outputs.pr_number }}"
            CHANGES_DESC="Automated changelog update"
          fi

          # Add widget context to title if applicable
          if [ "${{ steps.set_vars.outputs.is_widget_change }}" == "true" ]; then
            PR_TITLE="[Widget] $PR_TITLE"
          fi

          # Determine changelog file description
          if [ "${{ steps.set_vars.outputs.is_widget_change }}" == "true" ]; then
            CHANGELOG_DESC="Widget changelog (\`docs/chat_widget/changelog.md\`)"
          else
            CHANGELOG_DESC="Main changelog (\`docs/changelog.md\`)"
          fi

          echo "Creating pull request..."
          gh pr create \
            --title "$PR_TITLE" \
            --body "## Summary
          $CHANGES_DESC based on merged PR in open-chat-studio.

          **Source PR:** ${{ steps.set_vars.outputs.pr_url }}
          **PR Title:** ${{ steps.set_vars.outputs.pr_title }}
          **Author:** @${{ steps.set_vars.outputs.pr_author }}
          **Base Branch:** \`${{ steps.set_vars.outputs.base_branch }}\`
          **Widget Change:** ${{ steps.set_vars.outputs.is_widget_change == 'true' && '✅ Yes' || '❌ No' }}

          ### Changes Made
          - Changelog ($CHANGELOG_DESC): ${{ steps.check_changes.outputs.changelog_changed == '1' && '✅ Updated' || '⏭️ Skipped' }}
          - Documentation: ${{ steps.check_changes.outputs.docs_changed != '0' && '✅ Updated' || '⏭️ No updates needed' }}

          ---
          🤖 This PR was automatically generated using Claude to analyze the source PR and update the changelog and documentation accordingly.

          @claude please review the changes for accuracy, completeness, and style." \
            --label "automated,changelog" \
            --assignee "${{ steps.set_vars.outputs.pr_author }}" \
            --base "${{ steps.set_vars.outputs.base_branch }}" \
            --head "${{ env.branch_name }}" || { echo "Failed to create pull request"; exit 1; }
        env:
          GH_TOKEN: ${{ secrets.OCS_DOCS_PAT }}
